# loading file + generate data

	load 'colors.gnu'

	mass=0.5
	length=0.5

	i = system('./run -v -disable_nn -i -1.0018287596797761 1.4509353031128174 -1.1757459172029587 1.9564028029058869 -p 0.5 0.5 -dt 0.0032 -duration 15.0')
	! mv output.dat 01.dat
	i = system('./run -v -i -1.0018287596797761 1.4509353031128174 -1.1757459172029587 1.9564028029058869 -p 0.5 0.5 -dt 0.0032 -duration 15.0 -nnlayout 3 6 40 1 -w 0.41417066365666777 0.44532691605381436 0.10955839761863179 -0.7556299010880643 -0.5152926596773645 1.022798101713512 -1.5021725855009147 0.029322180402161058 0.3392587709049192 0.9073230567658837 -0.13877855876177564 -0.2840607763654766 -0.9081623029556144 0.29296811977961534 0.08372529726013203 -0.22589038745055667 0.9896339177780725 -1.312991837213848 0.9155806738391807 0.24474066915998563 -1.02946649903317 -0.7704386219346266 0.19209952261928875 -0.19440286594601952 0.8853376968588116 0.36700430471330064 0.3527870435997441 0.2511612834870845 1.9039085128908713 0.6992803427386118 -0.9969791526303415 1.00061498186983 0.32627424296055973 -0.04388922484302627 -1.1649049104412694 0.9407950661980539 -1.077049012798955 -0.03699107753677217 -0.7834697740365346 0.6495560753001001 1.4665395045294825 0.2700756942161547 1.5385353381787281 0.10006024515957468 0.06277329957140182 0.6431717096948518 -1.196121424743842 -0.3772174752233402 0.2797507159923465 0.33381253906745273 -0.8537284135427542 -0.1482858999899314 -0.16724447308445214 -1.3616122834238586 -0.5289923717267442 -0.6925923208356388 0.505837992619394 -0.1942680207056539 -0.8239900198066727 0.07456857582453562 0.6366410869432605 -0.05829017692591194 1.0279913634816384 1.2110298130062933 0.5426612879555821 1.5917205665585248 -0.07872584211151781 0.846820218732524 0.5533388818029076 -0.38066941510585084 0.04568562523628533 0.20734172426731518 -0.5558872911008731 0.4611007686566596 -0.26765827317897795 -0.17149206443566414 -1.305970745044391 0.12941511485089013 1.2137963932511662 -0.22095635270607128 0.41129755683557606 1.1618377401051696 0.23164860257825834 0.09852798840578028 0.9418593018378248 0.4784437191724786 -0.7917346450620716 -0.5348785417794698 1.3637764490687387 1.3063154624066 -0.9361334318265822 -0.42925633458265855 -0.664363119565483 -0.286085307056973 0.31296080557537104 0.3591717148442169 -0.590116438617029 -0.6284389299465987 0.0021635481969341803 -1.3879602271352756 -0.8297332565259988 0.8178459414692623 -0.13505863688029765 0.2831084944303288 -0.07125520537699667 -0.10975295456775702 -0.41021992573677196 0.9509739379271678 -0.38080167028913703 -1.0869900993252133 -0.19143550639700083 0.1401643957321732 -1.1247571388138458 -0.5832347808962778 1.2064549240644808 -0.8696768047318827 0.31360825312728996 0.931137204533764 -1.4134100722526715 0.47474951446707153 0.7639182791629048 -0.2385979281527081 -0.6725194737011914 0.43772042782784704 -1.0773787253148153 -0.0013957421523191384 -1.2580354024762084 0.017462209309749344 1.0262175042591544 -0.5278995390300403 0.1986587107746725 -0.010541118394802677 0.27804969009651453 1.0657103325186836 0.5282220524412277 0.9139976289651008 -0.47162967324154653 0.046984503551794954 -0.1624929661172254 -0.7752849302092804 0.33711482268181125 0.6846638881296793 0.33237678636668194 0.2574100282223801 -0.44482959473820277 0.22144593221920197 -0.18973201322356442 0.3844662665204891 0.01314171887356865 0.11713384739455475 -1.20636923996971 -0.4383102111095964 -1.45473035780675 0.029091485526243705 -1.1829454082602364 0.7689459036868185 -0.24358050566636583 -0.6547811397485576 0.17874625362189744 -0.3534045802274853 -0.906916014170989 -0.4296970311508269 0.6588229833648437 1.6020405095349384 0.6737028604305252 -0.4222639795008213 -0.49900515537269846 -0.6039541910232957 0.6306061633008591 1.3097589757485517 0.7430104188361928 0.16469109563329742 0.3722007584409953 -0.20995263179314722 0.9661437520332078 0.684130844834323 -0.7950833719595489 0.9879956622045457 0.06216265188589251 0.2656630173828032 -0.5543002990290786 0.31575167400804255 -0.32631521551468207 -0.0694363112111107 0.14928942416341823 -0.20554947395825468 -1.1282529090899704 -0.23118659836523278 -0.16183779500065038 0.08603976441995519 -0.2503040468560385 -1.2980571985618508 -2.2891176974760725 0.839141857729936 -0.059329852734285586 0.3847262127501956 0.8773262436985949 -0.20496243050500787 0.8724824167908952 1.4508310222436325 1.043838133738545 1.0636414548025261 -0.9373284792907263 0.5476823504076368 0.6474567072751789 1.2363975877673397 1.2555114364852626 0.8002924928592735 -0.4432893258501616 0.21098028403520105 0.3957327508747245 -0.27442369908535313 -0.17646101687180693 0.5818405893502027 0.8532158168479465 -1.1225825868961727 0.5329853780568122 -0.16150648667970754 -0.6408883552853629 -0.7424155629429761 0.16253680266270268 0.051019534168775305 1.3133258507149093 -1.0937153415396474 -0.5701017441160829 1.0733418292009913 0.16709691123532208 0.02359420802644272 -0.04623835957182333 -0.7430300503486748 0.48269330885924344 -1.3297779030812502 0.3321698104088792 0.9829092377661388 0.5037636146075598 -0.22555626950914914 0.6622193068219423 -0.29888285353064165 0.03560161509076974 1.1452082521832991 1.010058481054288 -1.0241116623004793 0.4035465654388466 1.0364070527402869 0.5192866433873891 -1.541677346202691 -0.18708049355273818 0.904579507403092 1.5659548428745775 -0.766589248744378 0.7343972557107538 0.8949373206321938 0.05341744052381621 1.100780688641892 -0.2822636401306844 -0.5166592852998146 -0.3313868558713357 -1.0618626774886382 1.4742417261154928 0.4522510435951661 -1.0482525659125346 -0.5071143906141753 0.5033349705912301 -1.0465042829360989 -0.5465248638850432 0.30089765124265444 0.9674348876580386 0.741139737809618 -0.9099960035639229 -0.464571870355924 -0.5479380058757242 -1.7402815998954686 -0.9005108662350184 0.7492529629509792 0.5067023972365903 1.3712376093497036 -0.5117607160335901 0.4574442326847438 -0.9838048568763413 -1.0110230070162916')
	! mv output.dat 02.dat

# actual plotting

	mass_radius=0.06
	sliderw=0.15
	sliderh=0.075

	xr0 = -2.6*length; xr1 = 2.6*length
	yr0 = -2.2*length; yr1 = 1.2*length

	set term pngcairo size 800, (yr1 - yr0)/(xr1 - xr0)*800 background rgb darkgray

	set size ratio -1

	unset tics; unset label; unset key
	set lmargin screen 0; set rmargin screen 1
	set bmargin screen 0; set tmargin screen 1

	! mkdir -p res

	# load data from files
	n = 469
	array thetai[n]
	array phii[n]
	array xi[n]
	stats '01.dat' u (i=floor($0+1.5), thetai[i] = $2, phii[i] = $4, xi[i] = $6) nooutput
	array thetai_2[n]
	array phii_2[n]
	array xi_2[n]
	stats '02.dat' u (i=floor($0+1.5), thetai_2[i] = $2, phii_2[i] = $4, xi_2[i] = $6) nooutput

	# generate frames
	set xr [xr0:xr1]
	set yr [yr0:yr1]

	max(x,y) = x<y?y:x
	min(x,y) = x>y?y:x
	do for [i=0:n-1:1] {
		print 'frame ', i+1, '/', n

		set output sprintf('res/plot%05d.png', i)

		set multiplot

			unset arrow; unset object

			# rail
				set arrow 1 from screen 0, first 0 to screen 1, first 0 nohead lw 10 lc rgb '#777777'

			# bumper left
				set object 4 rect from xr0-0.1, -1.1*sliderh to -length-0.5*sliderw, 1.1*sliderh fs solid noborder fc rgb '#555555' front
				set arrow 4 from xr0, -1.1*sliderh to -length-0.5*sliderw, -1.1*sliderh nohead lc rgb '#777777' lw 4 front
				set arrow 5 from -length-0.5*sliderw, -1.1*sliderh to -length-0.5*sliderw, 1.1*sliderh nohead lc rgb '#777777' lw 4 front
				set arrow 6 from -length-0.5*sliderw, 1.1*sliderh to xr0, 1.1*sliderh nohead lc rgb '#777777' lw 4 front
				height = 2.2*sliderh#0.03#
				width = 0.06
				nstrokes = 10
				somerange = -length - xr0
				do for [k = 0:nstrokes] {
					set arrow 7+k from -length-0.5*sliderw - (k+0.4)*somerange/nstrokes, -1.1*sliderh to -length-0.5*sliderw - (k+0.4)*somerange/nstrokes - width, -1.1*sliderh + height nohead lc rgb '#777777' lw 4 front
				}

			# bumper right
				set object 5 rect from length+0.5*sliderw, -1.1*sliderh to xr1+0.1, 1.1*sliderh fs solid noborder fc rgb '#555555' front
				set arrow 8+nstrokes from xr1, -1.1*sliderh to length+0.5*sliderw, -1.1*sliderh nohead lc rgb '#777777' lw 4 front
				set arrow 9+nstrokes from length+0.5*sliderw, -1.1*sliderh to length+0.5*sliderw, 1.1*sliderh nohead lc rgb '#777777' lw 4 front
				set arrow 10+nstrokes from length+0.5*sliderw, 1.1*sliderh to xr1, 1.1*sliderh nohead lc rgb '#777777' lw 4 front
				somerange = xr1 - length
				do for [k = 0:nstrokes] {
					set arrow 11+nstrokes+k from length+0.5*sliderw + (k+0.8)*somerange/nstrokes, -1.1*sliderh to length+0.5*sliderw + (k+0.8)*somerange/nstrokes - width, -1.1*sliderh + height nohead lc rgb '#777777' lw 4 front
				}

			# rods of pendulum
				set arrow 12+2*nstrokes from xi[i+1], 0 to xi[i+1]+length*sin(thetai[i+1]), -length*cos(thetai[i+1]) nohead lw 6 lc rgb lightgray front
				set arrow 13+2*nstrokes from xi[i+1]+length*sin(thetai[i+1]), -length*cos(thetai[i+1]) to xi[i+1]+length*sin(thetai[i+1])+length*sin(phii[i+1]), -length*cos(thetai[i+1])-length*cos(phii[i+1]) nohead lw 6 lc rgb lightgray front
			# rods of pendulum 2
				set arrow 14+2*nstrokes from xi_2[i+1], 0 to xi_2[i+1]+length*sin(thetai_2[i+1]), -length*cos(thetai_2[i+1]) nohead lw 6 lc rgb pastelred front
				set arrow 15+2*nstrokes from xi_2[i+1]+length*sin(thetai_2[i+1]), -length*cos(thetai_2[i+1]) to xi_2[i+1]+length*sin(thetai_2[i+1])+length*sin(phii_2[i+1]), -length*cos(thetai_2[i+1])-length*cos(phii_2[i+1]) nohead lw 6 lc rgb pastelred front

			pl 1/0

			unset arrow; unset object

			# pendulum masses
				set object 101 rect from xi[i+1]-0.5*sliderw, 0-0.5*sliderh to xi[i+1]+0.5*sliderw, 0+0.5*sliderh fs solid fc rgb lightgray front
				set object 102 circ at xi[i+1]+length*sin(thetai[i+1]), -length*cos(thetai[i+1]) size mass_radius fs solid border lc rgb '#000000' fc rgb lightgray front
				set object 103 circ at xi[i+1]+length*sin(thetai[i+1])+length*sin(phii[i+1]), -length*cos(thetai[i+1])-length*cos(phii[i+1]) size mass_radius fs solid border lc rgb '#000000' fc rgb lightgray front
			
			# pendulum masses 2
				set object 104 rect from xi_2[i+1]-0.5*sliderw, 0-0.5*sliderh to xi_2[i+1]+0.5*sliderw, 0+0.5*sliderh fs solid fc rgb newred front
				set object 105 circ at xi_2[i+1]+length*sin(thetai_2[i+1]), -length*cos(thetai_2[i+1]) size mass_radius fs solid border lc rgb '#000000' fc rgb newred front
				set object 106 circ at xi_2[i+1]+length*sin(thetai_2[i+1])+length*sin(phii_2[i+1]), -length*cos(thetai_2[i+1])-length*cos(phii_2[i+1]) size mass_radius fs solid border lc rgb '#000000' fc rgb newred front

		pl 1/0

		unset multiplot
		unset output
	}

# generate video output & cleanup
	! ffmpeg -framerate 30 -i res/plot%05d.png -c:v libx264 output.mp4
	! rm -r res
	! rm 01.dat 02.dat